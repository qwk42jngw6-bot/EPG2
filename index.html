<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TV Programm</title>
  <style>
    :root{
      --bg:#0f1419;
      --card:#1b2430;
      --text:#e6edf3;
      --muted:#94a3b8;
      --border:#2a3441;
      --accent:#3b82f6;
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; padding:16px;
      background:var(--bg); color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height:1.45;
    }
    .wrap{max-width:1200px;margin:0 auto;}
    header{
      display:flex;flex-wrap:wrap;gap:12px;
      align-items:center;justify-content:space-between;
      padding-bottom:12px;border-bottom:1px solid var(--border);margin-bottom:16px;
    }
    h1{margin:0;font-size:20px;font-weight:700;}
    .topline{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .muted{color:var(--muted);font-size:13px;}
    .btn, select{
      background:#121821;border:1px solid var(--border);color:var(--text);
      border-radius:8px;padding:8px 10px;font-size:14px;cursor:pointer;
    }
    .btn:hover{border-color:#3a495c}
    .grid{
      display:grid;gap:12px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;
    }
    .row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .ch-name{font-weight:700;font-size:15px;}
    .ch-no{font-size:12px;color:var(--muted);border:1px solid var(--border);border-radius:6px;padding:2px 6px;min-width:28px;text-align:center;}
    .prog-title{font-size:14px;margin-bottom:2px;}
    .prog-time{color:var(--muted);font-size:12px;}
    .nodata{color:var(--muted);font-size:13px;font-style:italic;}
    .bar{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .status{
      font-size:12px;color:var(--muted);
    }
    .error{
      background: #2a1517;
      border:1px solid #522327;
      color:#fca5a5;
      padding:10px 12px;border-radius:8px;margin-bottom:12px;
      font-size:14px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>TV&nbsp;Programm</h1>
      <div class="topline">
        <span id="clock" class="muted">--:--</span>
        <span id="updated" class="muted">Aktualisiert: —</span>
        <div class="bar">
          <!-- Optional: Quelle über URL ?set= -->
          <button id="btnRefresh" class="btn">Aktualisieren</button>
        </div>
      </div>
    </header>

    <div id="errorBox" class="error" style="display:none;"></div>

    <div id="stats" class="muted" style="margin-bottom:12px;"></div>

    <div id="grid" class="grid"></div>
  </div>

  <script>
    // -----------------------------
    // Konfiguration
    // -----------------------------
    // Reihenfolge der Sender (deine 35 Kanäle, exakt so gerendert):
    const CHANNEL_ORDER = [
      "ARD (Das Erste)",
      "ZDF",
      "RTL",
      "ProSieben",
      "Sat.1",
      "SWR",
      "Sky Sport F1 (Formel 1)",
      "Motorvision TV",
      "Sky Cinema Highlights",
      "Sky Cinema Action",
      "Sky Cinema Primera",
      "Sky Cinema Classic",
      "Sky Cinema Family",
      "Warner Bros. (Film & Serie)",
      "VOX",
      "RTL Zwei",
      "Kabel Eins",
      "Kabel Eins Doku",
      "BBC Food",
      "DMAX",
      "BBC Top Gear",
      "N24 Doku",
      "Discovery Channel",
      "Sky Documentaries",
      "History Channel",
      "Sky Nature",
      "Terra Mater",
      "National Geographic",
      "National Geo Wild",
      "Animal Planet",
      "Welt",
      "N-TV",
      "Tagesschau24",
      "Nick (Nickelodeon)",
      "MTV"
    ];

    // API-Basis per URL-Parameter ?api=...
    // Standard: dein Worker
    const urlParams = new URLSearchParams(location.search);
    const API_BASE = (urlParams.get("api") || "https://waterfall-epg.w2gy9ymm7y.workers.dev").replace(/\/+$/,"");
    // Quelle/Set per URL-Parameter ?set=live|alt|single (Standard: live)
    const SOURCE_SET = (urlParams.get("set") || "live").toLowerCase();

    // -----------------------------
    // Hilfsfunktionen
    // -----------------------------
    const fmtTime = (iso) => {
      if(!iso) return "—";
      const d = new Date(iso);
      if(isNaN(d)) return "—";
      return d.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
    };
    const fmtDateTime = (iso) => {
      const d = new Date(iso);
      if(isNaN(d)) return "—";
      return d.toLocaleString("de-DE",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    };
    const byLower = s => (s||"").toLowerCase();

    function showError(msg){
      const box = document.getElementById("errorBox");
      box.textContent = msg;
      box.style.display = "block";
    }
    function clearError(){
      const box = document.getElementById("errorBox");
      box.style.display = "none";
      box.textContent = "";
    }

    // Mappe API-Items (array) in ein Dictionary nach Kanalname (lower)
    function indexByChannel(items){
      const map = new Map();
      (items||[]).forEach(it => {
        const key = byLower(it.channel);
        if(!map.has(key)) map.set(key, it);
      });
      return map;
    }

    // Rendere die Karten in der festen Reihenfolge
    function render(items, ts, attempts, sourceUsed){
      const grid = document.getElementById("grid");
      const map = indexByChannel(items);
      let html = "";

      let haveCount = 0;
      CHANNEL_ORDER.forEach((name, idx) => {
        const it = map.get(byLower(name));
        if(it && it.now && it.now.title) haveCount++;

        html += `
          <div class="card">
            <div class="row1">
              <div class="ch-name">${name}</div>
              <div class="ch-no">${idx+1}</div>
            </div>
            ${
              it && it.now && it.now.title
              ? `
                <div class="prog-title">${escapeHtml(it.now.title)}</div>
                <div class="prog-time">${fmtTime(it.now.start)} – ${fmtTime(it.now.stop)}</div>
              `
              : `<div class="nodata">Keine Daten verfügbar</div>`
            }
          </div>
        `;
      });

      grid.innerHTML = html;

      // Kopfzeile updaten
      document.getElementById("updated").textContent = "Aktualisiert: " + (ts ? fmtDateTime(ts) : "—");

      // kleine Text-Stats
      const stats = document.getElementById("stats");
      stats.textContent = `${haveCount}/${CHANNEL_ORDER.length} Sender mit Programmdaten • Quelle: ${sourceUsed || "—"} • Set: ${SOURCE_SET}`;
    }

    // HTML Escaping für Titel
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // -----------------------------
    // Laden
    // -----------------------------
    async function loadEPG(){
      clearError();
      // Endpunkt: /api/now (optional mit ?set=)
      const url = `${API_BASE}/api/now${SOURCE_SET ? `?set=${encodeURIComponent(SOURCE_SET)}` : ""}`;
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok){
          showError(`Ladefehler (${r.status}) – ${r.statusText}`);
          render([], null, [], null);
          return;
        }
        const data = await r.json();

        // Erwartete Struktur:
        // { ts, sourceUsed, items: [{channel, now:{title,start,stop}, next:[...] }], attempts:[...] }
        const items = Array.isArray(data.items) ? data.items : [];
        render(items, data.ts, data.attempts || [], data.sourceUsed || "");

      }catch(err){
        showError(`NetworkError: ${err && err.message ? err.message : err}`);
        render([], null, [], null);
      }
    }

    // Uhr oben rechts
    function tickClock(){
      const el = document.getElementById("clock");
      const now = new Date();
      el.textContent = now.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    }

    // -----------------------------
    // Init
    // -----------------------------
    document.getElementById("btnRefresh").addEventListener("click", loadEPG);
    tickClock();
    setInterval(tickClock, 1000);
    loadEPG();

    // Auto-Refresh alle 5 Minuten
    setInterval(loadEPG, 5*60*1000);
  </script>
</body>
</html>
