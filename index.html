<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TV Programm</title>
<style>
  :root { --bg:#0f1419; --card:#1a1f26; --border:#2a2f35; --muted:#9ca3af; --accent:#60a5fa; }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,sans-serif;line-height:1.35;padding:16px}
  .container{max-width:1400px;margin:0 auto}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .ts{color:#94a3b8;font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px}
  .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;border-bottom:1px solid var(--border);padding-bottom:6px}
  .name{font-weight:700;font-size:14px}
  .no{font-size:12px;background:#1e3a8a;color:var(--accent);padding:2px 6px;border-radius:6px}
  .title{font-size:13px;margin-bottom:3px}
  .time{font-size:11px;color:var(--muted)}
  .none{font-size:12px;color:#6b7280;font-style:italic}
  .next{border-top:1px solid var(--border);margin-top:8px;padding-top:8px}
  .nx{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}
  .err{background:#7f1d1d;color:#fca5a5;border:1px solid #dc2626;border-radius:8px;padding:10px;margin-bottom:10px}
  button{background:#111827;border:1px solid var(--border);color:#e5e7eb;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer}
  button:hover{border-color:#3b82f6}
</style>
</head>
<body>
<div class="container">
  <div id="err"></div>
  <div class="toolbar">
    <div class="ts" id="ts">lädt…</div>
    <div style="display:flex;gap:8px">
      <button id="refresh">Aktualisieren</button>
    </div>
  </div>
  <div id="root"><div class="card"><div class="title">Lade Sender…</div></div></div>
</div>

<script>
const API_BASE = 'https://waterfall-epg.w2gy9ymm7y.workers.dev';

function fmt(t){const d=new Date(t);return d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}
function setErr(msg){document.getElementById('err').innerHTML = msg?(`<div class="err">${msg}</div>`):'';}

async function loadNow(){
  setErr('');
  document.getElementById('root').innerHTML = '<div class="card"><div class="title">Lade…</div></div>';
  try{
    const r = await fetch(`${API_BASE}/api/now`);
    const data = await r.json();
    render(data);
  }catch(e){
    setErr('Fehler beim Laden: '+e.message);
  }
}

function render(data){
  const items = (data && data.items)||[];
  document.getElementById('ts').textContent = data?.ts ? ('Stand: '+ new Date(data.ts).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})) : '';
  if(!items.length){ document.getElementById('root').innerHTML='<div class="card"><div class="title">Keine Daten</div></div>'; return; }
  const cards = items.map(ch=>{
    const now = ch.now ? `
      <div class="title">${ch.now.title}</div>
      <div class="time">${fmt(ch.now.start)} – ${fmt(ch.now.stop)}</div>
    ` : `<div class="none">Keine aktuelle Sendung</div>`;
    const next = (ch.next && ch.next.length) ? `
      <div class="next">
        ${ch.next.slice(0,2).map(n=>`<div class="nx"><span>${n.title}</span><span>${fmt(n.start)}</span></div>`).join('')}
      </div>` : '';
    return `
      <div class="card">
        <div class="hdr"><div class="name">${ch.channel}</div><div class="no">#${ch.no}</div></div>
        ${now}
        ${next}
      </div>`;
  }).join('');
  document.getElementById('root').innerHTML = `<div class="grid">${cards}</div>`;
}

document.getElementById('refresh').addEventListener('click', loadNow);
loadNow();
setInterval(loadNow, 300000);
</script>
</body>
</html>
