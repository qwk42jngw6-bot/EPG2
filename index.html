<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TV Programm</title>
<style>
  :root{
    --bg:#0f1419; --card:#1e293b; --muted:#94a3b8; --border:#334155;
    --accent:#60a5fa; --gold:#f5c518; --rt-user:#16a34a; --rt-critic:#dc2626; --score:#3b82f6; --text:#e2e8f0;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;line-height:1.4;padding:16px}
  .container{max-width:1200px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:20px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:8px;color:var(--text);cursor:pointer;font-size:13px}
  .btn.active{outline:2px solid var(--accent)}
  .ts{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .chan{font-weight:700}
  .no{background:#1e40af;color:#fff;border-radius:6px;padding:2px 8px;font-size:12px}
  .title{font-size:14px;margin:4px 0}
  .time{font-size:12px;color:var(--muted)}
  .next{border-top:1px solid var(--border);margin-top:8px;padding-top:8px}
  .next-item{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin:4px 0}
  .badges{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:11px;padding:3px 6px;border-radius:4px;border:1px solid var(--border);text-decoration:none}
  .b-imdb{background:var(--gold);color:#000}
  .b-rtu{background:var(--rt-user);color:#fff}
  .b-rtc{background:var(--rt-critic);color:#fff}
  .b-score{background:var(--score);color:#fff}
  .status{margin:8px 0;color:var(--muted);font-size:12px}
  .err{background:#7f1d1d;border:1px solid #dc2626;color:#fca5a5;padding:10px;border-radius:8px;margin-bottom:10px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>TV Programm</h1>
      <div id="ts" class="ts">–</div>
    </div>
    <div class="controls">
      <button class="btn" data-src="auto">Quelle: Auto</button>
      <button class="btn" data-src="xmltv">Quelle: xmltv.info</button>
      <button class="btn" data-src="epgpw">Quelle: epg.pw</button>
      <button class="btn" id="refresh">Aktualisieren</button>
    </div>
  </header>

  <div id="status" class="status"></div>
  <div id="error"></div>
  <div id="grid" class="grid"></div>
</div>

<script>
  // <<< HIER DEINE WORKER-URL EINTRAGEN >>>
  const WORKER = "https://waterfall-epg.w2gy9ymm7y.workers.dev";

  // UI state
  let currentSource = localStorage.getItem("epg_source") || "auto";

  // Button init
  document.querySelectorAll(".btn[data-src]").forEach(b=>{
    b.addEventListener("click", ()=>{
      currentSource = b.dataset.src;
      localStorage.setItem("epg_source", currentSource);
      highlight();
      load();
    });
  });
  document.getElementById("refresh").addEventListener("click", load);
  function highlight(){
    document.querySelectorAll(".btn[data-src]").forEach(b=>{
      b.classList.toggle("active", b.dataset.src===currentSource);
    });
  }
  highlight();

  // Cache für Ratings
  const ratingCache = new Map();
  const persisted = JSON.parse(sessionStorage.getItem('ratingsCache')||'{}');
  for (const k of Object.keys(persisted)) ratingCache.set(k, persisted[k]);
  function saveCache(){
    const obj={}; for (const [k,v] of ratingCache.entries()) obj[k]=v;
    sessionStorage.setItem('ratingsCache', JSON.stringify(obj));
  }
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const esc = (s)=>String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/>/g,"&gt;");

  async function load(){
    setStatus("Lade…");
    setError("");
    try{
      const r = await fetch(`${WORKER}/api/now?source=${encodeURIComponent(currentSource)}`);
      const data = await r.json();
      document.getElementById("ts").textContent = `Aktualisiert: ${fmtTs(data.ts)} | Quelle: ${data.sourceUsed || '–'}`;
      render(data.items||[]);
      setStatus(renderAttempts(data.attempts||[]));

      // Ratings einsammeln
      await collectAndFetchRatings();
    }catch(e){
      setError("Ladefehler: " + esc(e.message||e));
      setStatus("");
    }
  }

  function render(items){
    const grid = document.getElementById("grid");
    if (!items || !items.length){
      grid.innerHTML = `<div class="err">Keine Senderdaten verfügbar.</div>`;
      return;
    }
    grid.innerHTML = items.map(row=>{
      const now=row.now;
      const next=row.next||[];
      // Titel für Ratings bestimmen (aktuelle Sendung)
      const rateKey = now?.title ? now.title : (next[0]?.title || "");
      return `
        <div class="card">
          <div class="row">
            <div class="chan">${esc(row.channel)}</div>
            <div class="no">${row.no}</div>
          </div>
          <div class="title">${now?esc(now.title):"<i>Keine aktuelle Sendung</i>"}</div>
          <div class="time">${now? timeRange(now.start, now.stop) : ""}</div>

          ${next.length?`
            <div class="next">
              ${next.map(n=>`<div class="next-item"><span>${esc(n.title)}</span><span>${timeOnly(n.start)}</span></div>`).join("")}
            </div>
          `:""}

          <div class="badges" data-title="${esc(rateKey)}"></div>
        </div>
      `;
    }).join("");
  }

  function timeOnly(iso){
    const d=new Date(iso);
    return d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
  }
  function timeRange(a,b){
    const da=new Date(a), db=new Date(b);
    return `${da.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})} – ${db.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}`;
  }
  function fmtTs(iso){
    const d=new Date(iso);
    return d.toLocaleString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  }
  function setStatus(t){ document.getElementById("status").textContent=t||""; }
  function setError(html){ document.getElementById("error").innerHTML = html?`<div class="err">${html}</div>`:""; }
  function renderAttempts(atts){
    if (!atts || !atts.length) return "";
    return "Versuche: " + atts.map(a=>{
      const s = a.ok? "OK" : (a.status||a.error||"ERR");
      return `[${s}]`;
    }).join(" ");
  }

  // Ratings mit Limit (3 parallel) + Session-Cache
  const R_CONC = 3;
  async function collectAndFetchRatings(){
    const blocks = [...document.querySelectorAll('.badges[data-title]')];
    const titles = [...new Set(blocks.map(b => b.dataset.title).filter(Boolean))];

    // vorhandene aus Cache sofort rendern
    for (const t of titles) {
      const cached = ratingCache.get(t);
      if (cached) updateBadgeDom(t, cached);
    }

    const queue = titles.filter(t => t && !ratingCache.has(t));
    if (!queue.length) return;

    let idx = 0;
    const workers = Array.from({length: Math.min(R_CONC, queue.length)}, ()=>runner());

    async function runner(){
      while (idx < queue.length) {
        const t = queue[idx++];
        try {
          const r = await fetch(`${WORKER}/api/ratings?title=${encodeURIComponent(t)}`);
          if (r.ok) {
            const data = await r.json();
            const pack = { ratings: data.ratings||{}, links: data.links||{} };
            ratingCache.set(t, pack);
            updateBadgeDom(t, pack);
          } else {
            ratingCache.set(t, {}); // leer
          }
        } catch {
          ratingCache.set(t, {});
        }
        saveCache();
        await sleep(150);
      }
    }

    function updateBadgeDom(titleKey, pack){
      document.querySelectorAll(`.badges[data-title]`).forEach(node=>{
        if (node.dataset.title !== titleKey) return;
        const R = pack.ratings||{}, L = pack.links||{};
        node.innerHTML = `
          ${R.imdb!=null ? `<a class="badge b-imdb" ${L.imdb?`href="${L.imdb}" target="_blank" rel="noopener noreferrer"`:""}>IMDb ${Number(R.imdb).toFixed(1)}</a>`:""}
          ${R.rtUser!=null ? `<a class="badge b-rtu" ${L.rt?`href="${L.rt}" target="_blank" rel="noopener noreferrer"`:""}>RT ${R.rtUser}%</a>`:""}
          ${R.rtCritic!=null ? `<a class="badge b-rtc" ${L.rt?`href="${L.rt}" target="_blank" rel="noopener noreferrer"`:""}>RT ${R.rtCritic}%</a>`:""}
          ${R.score!=null ? `<span class="badge b-score">Score ${Number(R.score).toFixed(1)}/10</span>`:""}
        `;
      });
    }
  }

  // Start
  load();
  // Auto-Refresh alle 5 Minuten
  setInterval(load, 300000);
</script>
</body>
</html>
