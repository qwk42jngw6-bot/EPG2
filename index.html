<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EPG – Jetzt (Germany 2)</title>
<style>
:root{--bg:#0a0a0a;--fg:#f5f5f5;--muted:#4b4b4b;--card:#121212;--border:#232323;--ok:#22c55e;--warn:#eab308}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Inter,Segoe UI,Roboto,sans-serif}
header{padding:12px;border-bottom:1px solid var(--border)}
h1{margin:0;font-size:18px}
.stamp{font-size:12px;color:#aaa;margin-top:4px}
.container{padding:10px}
.grid{display:grid;gap:10px}
@media(min-width:760px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.no{color:#666;font-size:12px}
.ch{font-weight:700}
.now{color:var(--ok);font-weight:600}
.warn{color:var(--warn);font-size:12px}
.rating{margin-top:6px;font-size:12px;color:#ccc}
ul{padding-left:15px;margin:5px 0}
</style>
</head>
<body>
<header>
  <h1>EPG – Jetzt</h1>
  <div id="stamp" class="stamp"></div>
</header>
<div class="container">
  <div id="root" class="grid"></div>
</div>
<script>
const api="/api/now";
const $=s=>document.querySelector(s);
const stamp=$("#stamp"),root=$("#root");
const tt=d=>new Date(d).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});

function upcomingList(arr){
  if(!arr||!arr.length)return'<div class="muted">Keine weiteren Sendungen (2 h).</div>';
  const items=arr.map(p=>`<li>${p.title} <span class="muted">(${tt(p.start)}–${tt(p.stop)})</span></li>`).join("");
  return `<div><strong>Nächste 2 Stunden:</strong><ul>${items}</ul></div>`;
}

async function load(){
  stamp.textContent="Lade…";
  try{
    const r=await fetch(api,{cache:"no-store"});
    const j=await r.json();
    stamp.textContent="Stand: "+new Date(j.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    root.innerHTML="";
    for(const it of j.items){
      const div=document.createElement("div");div.className="card";
      const head=`<div class="top"><span class="no">#${it.no}</span><div class="ch">${it.channel}</div></div>`;
      if(!it.now){
        div.innerHTML=head+`<div class="warn">Kein aktuelles Programm gefunden</div>`;
      }else{
        const when=it.now.start&&it.now.stop?` (${tt(it.now.start)}–${tt(it.now.stop)})`:"";
        let rating="";
        if(it.rating&&it.rating.gpt){
          rating=`<div class="rating">⭐ GPT-Score: ${it.rating.gpt}/10 
          (IMDb: ${it.rating.imdb??"-"}, RT: ${it.rating.rtUser??"-"}%)</div>`;
        }
        div.innerHTML=head+`<div class="now">${it.now.title}${when}</div>`+upcomingList(it.upcoming)+rating;
      }
      root.appendChild(div);
    }
  }catch(e){
    stamp.textContent="Fehler: "+(e?.message||e);
  }
}
load();
</script>
</body>
</html>
