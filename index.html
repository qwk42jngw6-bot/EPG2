<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TV Programm</title>
<style>
  :root{
    --bg:#0f1419; --fg:#e2e8f0; --muted:#94a3b8; --card:#1e293b; --line:#334155;
    --brand:#60a5fa; --gold:#f5c518; --rt-red:#dc2626; --rt-green:#16a34a; --score:#3b82f6;
  }
  *{ box-sizing:border-box; margin:0; padding:0 }
  body{ background:var(--bg); color:var(--fg); font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,system-ui,sans-serif; line-height:1.4; padding:16px }
  .container{ max-width:1200px; margin:0 auto }
  .header{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--line) }
  h1{ font-size:20px }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  select,button{ background:var(--card); color:var(--fg); border:1px solid var(--line); border-radius:8px; padding:8px 10px; font-size:14px }
  button.primary{ border-color:var(--brand) }
  .timestamp{ color:var(--muted); font-size:12px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:12px }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px }
  .head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
  .chname{ font-weight:600; font-size:15px }
  .no{ color:#93c5fd; font-size:12px; font-weight:700 }
  .now{ margin-bottom:8px }
  .title a{ color:var(--fg); text-decoration:underline; }
  .time{ color:var(--muted); font-size:12px }
  .next .item{ display:flex; justify-content:space-between; font-size:12px; color:var(--muted) }
  .ratings{ margin-top:8px; display:flex; flex-wrap:wrap; gap:6px }
  .badge{ font-size:11px; padding:3px 7px; border-radius:6px; display:inline-flex; gap:6px; align-items:center; }
  .b-imdb{ background:var(--gold); color:#000 }
  .b-rtc{ background:var(--rt-red); color:#fff }
  .b-rtu{ background:var(--rt-green); color:#fff }
  .b-score{ background:var(--score); color:#fff }
  .muted{ color:var(--muted) }
  .error{ background:#7f1d1d; color:#fca5a5; border:1px solid #dc2626; padding:12px; border-radius:8px; margin-bottom:10px; }
  .note{ color:var(--muted); font-size:12px; margin-top:6px }
</style>
</head>
<body>
<div class="container">
  <div id="err" class="error" style="display:none"></div>

  <div class="header">
    <h1>TV Programm</h1>
    <div class="row">
      <label for="sourceSel" class="muted">Quelle:</label>
      <select id="sourceSel" title="EPG-Quelle wählen">
        <option value="auto">Auto (xmltv.info → epg.pw)</option>
        <option value="xmltv">xmltv.info</option>
        <option value="epgpw">epg.pw</option>
      </select>
      <button id="reload" class="primary">Neu laden</button>
    </div>
    <div class="timestamp" id="ts">–</div>
  </div>

  <div id="content" class="grid"></div>
</div>

<script>
const WORKER_BASE = "https://waterfall-epg.w2gy9ymm7y.workers.dev"; // <--- DEIN WORKER
const contentEl = document.getElementById("content");
const tsEl = document.getElementById("ts");
const errEl = document.getElementById("err");
const sourceSel = document.getElementById("sourceSel");
document.getElementById("reload").addEventListener("click", loadEPG);

async function loadEPG(){
  showErr(""); contentEl.innerHTML = "<div class='muted'>Lade…</div>";
  try{
    const set = sourceSel.value || "auto";
    const r = await fetch(`${WORKER_BASE}/api/now?set=${encodeURIComponent(set)}`);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();

    tsEl.textContent = `Aktualisiert: ${formatDT(data.ts)} · Quelle: ${friendlySource(data.sourceUsed)}`;
    renderItems(data.items || []);
  }catch(e){
    showErr("Ladefehler: " + (e.message||e));
    contentEl.innerHTML = "";
  }
}

function renderItems(items){
  const html = items.map(row=>{
    const now = row.now;
    const next = Array.isArray(row.next) ? row.next : [];
    const nowTitle = now?.title ? escapeHtml(now.title) : "Keine aktuelle Sendung";
    const nowTime = now?.start ? `${fmtTime(now.start)} – ${fmtTime(now.stop)}` : "";
    const nextHtml = next.slice(0,2).map(n=>(
      `<div class="item"><span>${escapeHtml(n.title)}</span><span>${fmtTime(n.start)}</span></div>`
    )).join("");

    const googNowLink = now?.title ? googleLink(now.title) : null;

    return `
    <div class="card" data-chan="${escapeHtml(row.channel)}">
      <div class="head">
        <div class="chname">${escapeHtml(row.channel)}</div>
        <div class="no">#${row.no}</div>
      </div>

      <div class="now">
        <div class="title">${
          googNowLink
            ? `<a href="${googNowLink}" target="_blank" rel="noopener">${nowTitle}</a>`
            : nowTitle
        }</div>
        ${ nowTime ? `<div class="time">${nowTime}</div>` : "" }
      </div>

      ${ nextHtml ? `<div class="next">${nextHtml}</div>` : "" }

      <div class="ratings" data-title="${escapeHtml(now?.title||"")}"></div>
      <div class="note">Tipp: Titel anklicken → Google-Suche</div>
    </div>`;
  }).join("");

  contentEl.innerHTML = html;

  // Ratings lazy nachladen (pro Karte separat)
  document.querySelectorAll(".card .ratings").forEach(loadRatingsForCard);
}

async function loadRatingsForCard(el){
  const title = (el.getAttribute("data-title")||"").trim();
  if(!title) return;

  try{
    // Platzhalter
    el.innerHTML = `<span class="muted">Bewertungen laden…</span>`;
    const r = await fetch(`${WORKER_BASE}/api/ratings?title=${encodeURIComponent(title)}`);
    const data = await r.json();
    const ra = data.ratings || {};
    const links = data.links || {};

    const parts = [];
    if (ra.imdb != null){
      parts.push(`<a class="badge b-imdb" href="${escapeAttr(links.imdb||googleSite(title,'imdb.com'))}" target="_blank" rel="noopener">IMDb ${ra.imdb.toFixed(1)}</a>`);
    }
    if (ra.rtCritic != null){
      parts.push(`<a class="badge b-rtc" href="${escapeAttr(links.rt||googleSite(title,'rottentomatoes.com'))}" target="_blank" rel="noopener">RT Kritiker ${ra.rtCritic}%</a>`);
    }
    if (ra.rtUser != null){
      parts.push(`<a class="badge b-rtu" href="${escapeAttr(links.rt||googleSite(title,'rottentomatoes.com'))}" target="_blank" rel="noopener">RT User ${ra.rtUser}%</a>`);
    }
    if (ra.score != null){
      parts.push(`<span class="badge b-score">Score ${ra.score.toFixed(1)}/10</span>`);
    }

    el.innerHTML = parts.length ? parts.join(" ") : `<span class="muted">Keine Bewertungen</span>`;
  }catch(_){
    el.innerHTML = `<span class="muted">Bewertungen nicht verfügbar</span>`;
  }
}

// ---------- utils ----------
function googleLink(q){ return `https://www.google.com/search?q=${encodeURIComponent(q)}`; }
function googleSite(q,site){ return `https://www.google.com/search?q=${encodeURIComponent(q + " site:"+site)}`; }
function fmtTime(iso){ const d=new Date(iso); return d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}); }
function formatDT(iso){ const d=new Date(iso); return d.toLocaleString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) }
function friendlySource(u){
  if(!u) return "Fallback";
  if(u.includes("xmltv.info")) return "xmltv.info";
  if(u.includes("epg.pw")) return "epg.pw";
  return u;
}
function showErr(msg){
  if(!msg){ errEl.style.display="none"; errEl.textContent=""; return; }
  errEl.style.display="block"; errEl.textContent = msg;
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
function escapeAttr(s){ return escapeHtml(s||""); }

// Initial load & Intervall
loadEPG();
setInterval(loadEPG, 5*60*1000);
</script>
</body>
</html>
