<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EPG – Jetzt</title>
<style>
  body{margin:0;background:#0f1419;color:#e2e8f0;font-family:system-ui,sans-serif}
  .wrap{max-width:1400px;margin:0 auto;padding:16px}
  .top{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tabs button{background:#1e293b;border:1px solid #334155;color:#cbd5e1;padding:8px 12px;border-radius:8px;cursor:pointer}
  .tabs button.active{background:#0b5cff;border-color:#0b5cff;color:#fff}
  .force{display:flex;gap:8px;align-items:center}
  .force input{width:70px;padding:6px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:#e2e8f0}
  .btn{padding:8px 12px;border:1px solid #334155;border-radius:8px;background:#1e293b;color:#cbd5e1;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;margin-top:16px}
  .card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:14px;position:relative}
  .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .no{background:#1e40af;color:#60a5fa;padding:2px 8px;border-radius:6px;font-weight:700}
  .live{position:absolute;top:10px;right:10px;background:#dc2626;color:#fff;border-radius:12px;padding:2px 8px;font-size:11px}
  .sub{color:#94a3b8;font-size:12px}
  .next{border-top:1px solid #334155;margin-top:8px;padding-top:8px;color:#94a3b8;font-size:12px}
  .stamp{color:#94a3b8;margin-top:8px}
  details{margin-top:16px;background:#0b1220;border:1px solid #334155;border-radius:8px;padding:8px}
  summary{cursor:pointer}
  pre{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;color:#a3bffa}
  .err{background:#7f1d1d;border:1px solid #dc2626;padding:10px;border-radius:8px;margin-top:10px;color:#fca5a5}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="tabs">
      <button data-set="single" class="active">Einzel-Feeds</button>
      <button data-set="alt">Alternativ</button>
      <button data-set="all">Alle</button>
    </div>
    <div class="force">
      <label>Quelle erzwingen (Index): <input id="forceIdx" type="number" min="0" step="1" placeholder="z.B. 0"></label>
      <button class="btn" id="btnReload">Neu laden</button>
      <button class="btn" id="btnList">Quellenliste</button>
    </div>
    <div id="used" class="stamp"></div>
  </div>

  <div id="content" class="grid"></div>

  <details id="dbg">
    <summary>Debug</summary>
    <div id="debugBox"></div>
  </details>
</div>

<script>
const API = "https://waterfall-epg.w2gy9ymm7y.workers.dev"; // deinen Worker-Host einsetzen, falls anders
let currentSet = "single";

document.querySelectorAll(".tabs button").forEach(b=>{
  b.addEventListener("click", ()=>{
    document.querySelectorAll(".tabs button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    currentSet = b.dataset.set;
    loadNow();
  });
});

document.getElementById("btnReload").addEventListener("click", loadNow);
document.getElementById("btnList").addEventListener("click", async ()=>{
  const r = await fetch(`${API}/api/sources?set=${currentSet}`);
  const d = await r.json();
  dumpDebug({type:"sources", data:d});
  alert(`Set "${currentSet}"\nQuellen:\n` + d.sources.map((s,i)=>`[${i}] ${s}`).join("\n"));
});

async function loadNow(){
  const idx = document.getElementById("forceIdx").value.trim();
  const p = new URLSearchParams({ set: currentSet, debug: "1" });
  if (idx !== "") p.set("i", idx);
  try{
    const r = await fetch(`${API}/api/now?`+p.toString());
    const data = await r.json();
    render(data);
    dumpDebug({type:"now", data});
  }catch(e){
    showError("NetworkError: " + e.message);
  }
}

function render(data){
  const box = document.getElementById("content");
  const used = document.getElementById("used");
  box.innerHTML = "";
  used.textContent = data.sourceUsed ? `Quelle: ${data.sourceUsed}` : "";

  (data.items||[]).forEach(ch=>{
    const live = ch.now && ch.now.title;
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      ${live ? `<div class="live">LIVE</div>` : ``}
      <div class="head">
        <div><strong>${escapeHtml(ch.channel)}</strong></div>
        <div class="no">#${ch.no}</div>
      </div>
      <div>
        ${live ? `
          <div>${escapeHtml(ch.now.title)}</div>
          <div class="sub">${fmt(ch.now.start)} – ${fmt(ch.now.stop)}</div>
        ` : `<div class="sub">Keine aktuelle Sendung</div>`}
      </div>
      ${ch.next && ch.next.length ? `
        <div class="next">
          ${ch.next.map(n=>`<div>${escapeHtml(n.title)} <span class="sub">(${fmt(n.start)})</span></div>`).join("")}
        </div>` : ``}
    `;
    box.appendChild(div);
  });
}

function showError(msg){
  document.getElementById("content").innerHTML = `<div class="err">${msg}</div>`;
}

function fmt(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
  }catch{ return ""; }
}

function dumpDebug(obj){
  const el = document.getElementById("debugBox");
  const pre = document.createElement("pre");
  pre.textContent = JSON.stringify(obj,null,2);
  el.prepend(pre);
  // nur die letzten 6 Blöcke behalten
  while(el.childNodes.length>6) el.removeChild(el.lastChild);
}

function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));}

// Start
loadNow();
</script>
</body>
</html>
