<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TV Programm</title>
<style>
  :root{
    --bg:#0f1419; --card:#1e293b; --border:#334155; --muted:#94a3b8; --text:#e2e8f0;
    --gold:#f5c518; --red:#dc2626; --green:#16a34a; --blue:#3b82f6;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:0;padding:16px}
  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px}
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  select,button{background:#111827;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer}
  button:hover,select:hover{border-color:#475569}
  .stamp{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .chname{font-weight:700}
  .no{font-size:12px;color:#60a5fa;background:#1e40af;padding:2px 8px;border-radius:999px}
  .slot{margin:8px 0;padding:8px;border:1px dashed var(--border);border-radius:8px}
  .title{font-weight:600;cursor:pointer;text-decoration:none;color:var(--text)}
  .time{font-size:12px;color:var(--muted);margin-top:2px}
  .badges{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:11px;padding:2px 6px;border-radius:6px;display:inline-flex;gap:6px;align-items:center}
  .imdb{background:var(--gold);color:#000}
  .rtc{background:var(--red);color:#fff}
  .rtu{background:var(--green);color:#fff}
  .score{background:var(--blue);color:#fff}
  .muted{opacity:.65}
  .err{background:#7f1d1d;color:#fca5a5;border:1px solid var(--red);padding:10px;border-radius:8px;margin-bottom:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>TV Programm</h1>
      <div class="stamp" id="stamp">–</div>
    </div>
    <div class="controls">
      <select id="source">
        <option value="auto">Quelle: Auto</option>
        <option value="xmltv">Quelle: xmltv.info</option>
        <option value="epgpw">Quelle: epg.pw</option>
      </select>
      <button id="reload">Neu laden</button>
      <button id="probe">Quellen testen</button>
    </div>
  </header>

  <div id="error"></div>
  <div id="grid" class="grid"></div>
</div>

<script>
const API = "https://waterfall-epg.w2gy9ymm7y.workers.dev"; // <--- DEIN WORKER-URL

document.getElementById("reload").onclick = load;
document.getElementById("probe").onclick = probe;
document.getElementById("source").onchange = load;

function fmt(t){ const d=new Date(t); return d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}); }
function iso(){ return new Date().toISOString(); }
function gSearchUrl(title){ return `https://www.google.com/search?q=${encodeURIComponent(title)}`; }

function badge(label, value, cls, href){
  const inner = `<span>${label} ${value}</span>`;
  return href ? `<a class="badge ${cls}" href="${href}" target="_blank" rel="noopener">${inner}</a>`
              : `<span class="badge ${cls}">${inner}</span>`;
}

function ratingBadges(r){
  if(!r) return '';
  const out=[];
  if(typeof r.imdb === 'number') out.push(badge("IMDb", r.imdb.toFixed(1), "imdb", r.imdbUrl||null));
  if(typeof r.rtCritic === 'number') out.push(badge("RT Critic", r.rtCritic+"%", "rtc", r.rtUrl||null));
  if(typeof r.rtUser === 'number') out.push(badge("RT User", r.rtUser+"%", "rtu", r.rtUrl||null));
  if(typeof r.score === 'number') out.push(badge("Score", r.score.toFixed(1), "score", null));
  return `<div class="badges">${out.join("")}</div>`;
}

function slotHtml(s){
  if(!s) return `<div class="slot muted">Keine Daten</div>`;
  const linkTitle = `<a class="title" href="${gSearchUrl(s.title)}" target="_blank" rel="noopener">${s.title}</a>`;
  return `<div class="slot">
    ${linkTitle}
    <div class="time">${new Date(s.start).toLocaleDateString('de-DE',{weekday:'short'})} · ${fmt(s.start)}–${fmt(s.stop)}</div>
    ${ratingBadges(s.ratings)}
  </div>`;
}

async function load(){
  setErr('');
  const src = document.getElementById("source").value;
  document.getElementById("stamp").textContent = "Lade…";
  document.getElementById("grid").innerHTML = "";

  try{
    const r = await fetch(`${API}/api/now?source=${encodeURIComponent(src)}`);
    if(!r.ok) throw new Error(`${r.status}`);
    const data = await r.json();

    document.getElementById("stamp").textContent = `Aktualisiert: ${new Date(data.ts).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`;

    const grid = document.getElementById("grid");
    grid.innerHTML = data.items.map(item=>{
      return `<div class="card">
        <div class="row">
          <div class="chname">${item.channel}</div>
          <div class="no">#${item.no}</div>
        </div>
        ${slotHtml(item.now)}
        ${Array.isArray(item.next) ? item.next.map(slotHtml).join("") : ""}
      </div>`;
    }).join("");

    // Hinweis, falls Fallback
    if((data.sourceUsed||"").includes("fallback")) {
      setErr("Hinweis: Fallback-Daten – Quelle nicht erreichbar.");
    }

  }catch(e){
    setErr("Ladefehler: " + e.message);
  }
}

async function probe(){
  setErr('');
  const urls = [
    "https://xmltv.info/de/epg.xml",
    "https://epg.pw/xmltv/epg_DE.xml"
  ];
  const results = [];
  for(const u of urls){
    try{
      const r = await fetch(`${API}/api/probe?url=${encodeURIComponent(u)}`);
      const j = await r.json();
      results.push(`${u} → ${j.status} (${j.ct||"-"})`);
    }catch(e){
      results.push(`${u} → ERROR ${e.message}`);
    }
  }
  setErr(results.map(x=>`• ${x}`).join("<br>"));
}

function setErr(html){
  document.getElementById("error").innerHTML = html ? `<div class="err">${html}</div>` : "";
}

// Initial
load();
// Auto-Refresh alle 5 Minuten
setInterval(load, 300000);
</script>
</body>
</html>
