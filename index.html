<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TV Programm</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0f1419; color:#e2e8f0; }
  .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
  .header { display:flex; gap:8px; align-items:baseline; border-bottom:1px solid #334155; padding-bottom:10px; margin-bottom:12px; }
  h1 { margin: 0; font-size: 22px; }
  .timestamp { font-size: 12px; opacity: .7; }

  .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 16px; }
  .toolbar button {
    background:#1e293b; color:#e2e8f0; border:1px solid #334155; border-radius:8px; padding:8px 10px; cursor:pointer;
  }
  .toolbar button:hover { border-color:#475569; transform: translateY(-1px); }

  .stats { display:flex; gap:12px; flex-wrap:wrap; margin: 0 0 12px; }
  .stat { background:#0b1220; border:1px solid #334155; border-radius:8px; padding:8px 10px; }
  .stat b { font-size: 16px; }

  .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:12px; }
  .card { background:#1e293b; border:1px solid #334155; border-radius:12px; padding:12px; position:relative; }
  .ch { font-weight:600; }
  .no { font-size:12px; opacity:.7; }
  .live { position:absolute; top:10px; right:10px; font-size:10px; background:#dc2626; color:#fff; padding:3px 8px; border-radius:999px; }
  .current { margin:8px 0; }
  .title { font-size:14px; }
  .time { font-size:12px; opacity:.8; }
  .next { border-top:1px solid #334155; margin-top:8px; padding-top:8px; }
  .next-item { display:flex; justify-content:space-between; font-size:12px; opacity:.9; }

  .errorbox { background:#7f1d1d; border:1px solid #dc2626; color:#fca5a5; border-radius:8px; padding:12px; margin:12px 0; }
  .loading { text-align:center; padding:40px 0; opacity:.8; }
  .attempts { background:#0b1220; border:1px dashed #334155; border-radius:8px; padding:10px; margin:14px 0; }
  .attempt { font-size:12px; border:1px dashed #334155; border-radius:6px; padding:8px; margin-top:8px; }
  .footer { font-size:12px; opacity:.7; margin-top:16px; }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>TV Programm</h1>
      <div class="timestamp" id="ts"></div>
    </div>

    <div class="toolbar">
      <button data-set="live">Live (xmltv.info + epg.pw)</button>
      <button data-set="alt">Alt (Testquellen)</button>
      <button id="btn-adhoc">Ad-hoc URL(s)</button>
      <div style="margin-left:auto; font-size:12px; opacity:.8" id="activeSet"></div>
    </div>

    <div class="stats">
      <div class="stat"><b id="total">0</b> Kanäle</div>
      <div class="stat"><b id="livecount">0</b> Live</div>
    </div>

    <div id="error"></div>
    <div id="content"></div>
    <div id="attempts"></div>
    <div class="footer" id="footer"></div>
  </div>

<script>
const API = "https://waterfall-epg.w2gy9ymm7y.workers.dev";

document.querySelectorAll('button[data-set]').forEach(b=>{
  b.addEventListener('click', ()=> loadNow({ set: b.getAttribute('data-set') }));
});

document.getElementById('btn-adhoc').addEventListener('click', ()=>{
  const val = prompt("Gib Quelle(n) ein (Komma oder | trennen):", "https://xmltv.info/de/epg.xml,https://epg.pw/xmltv/epg_DE.xml");
  if (val) loadNow({ src: val });
});

function fmtTime(iso) {
  if (!iso) return "";
  const d = new Date(iso);
  return d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
}

function setText(id, s) { const el = document.getElementById(id); if (el) el.textContent = s; }

function showLoading() {
  document.getElementById('error').innerHTML = "";
  document.getElementById('attempts').innerHTML = "";
  document.getElementById('content').innerHTML = `<div class="loading">Lade TV-Programm…</div>`;
}

function showError(title, msg) {
  document.getElementById('error').innerHTML = `<div class="errorbox"><b>${title}</b><div>${msg||""}</div></div>`;
}

function showAttempts(attempts=[]) {
  const box = document.getElementById('attempts');
  if (!attempts.length) { box.innerHTML = ""; return; }
  box.innerHTML = `
    <div class="attempts">
      <div style="font-weight:600;margin-bottom:6px">Fetch-Versuche</div>
      ${attempts.map((a,i)=>`
        <div class="attempt">
          <div><b>#${i}</b> ${a.src||a.url||''}</div>
          <div>Status: ${a.status ?? (a.ok===false?'ERR':'OK')} · CT: ${a.ct||'-'} · Len: ${a.len||'-'}</div>
          ${a.hint?`<div>Hinweis: ${a.hint}</div>`:''}
          ${a.error?`<div>Error: ${a.error}</div>`:''}
        </div>
      `).join('')}
    </div>
  `;
}

function renderItems(data) {
  const items = data.items || [];
  let liveCount = 0;
  const cards = items.map(it=>{
    const hasNow = it.now && it.now.title;
    if (hasNow) liveCount++;
    return `
      <div class="card">
        ${hasNow?`<div class="live">LIVE</div>`:''}
        <div class="ch">${it.channel} <span class="no">#${it.no}</span></div>
        <div class="current">
          ${hasNow
            ? `<div class="title">${it.now.title}</div>
               <div class="time">${fmtTime(it.now.start)} – ${fmtTime(it.now.stop)}</div>`
            : `<div class="title" style="opacity:.7"><i>Keine aktuelle Sendung</i></div>`
          }
        </div>
        ${it.next && it.next.length ? `
          <div class="next">
            ${it.next.map(n=>`
              <div class="next-item">
                <span>${n.title}</span>
                <span>${fmtTime(n.start)}</span>
              </div>
            `).join('')}
          </div>` : ``}
      </div>
    `;
  }).join('');

  document.getElementById('content').innerHTML = `<div class="grid">${cards}</div>`;
  setText('livecount', liveCount.toString());
  setText('total', items.length.toString());
  if (data.ts) setText('ts', `Aktualisiert: ${new Date(data.ts).toLocaleString('de-DE')}`);
  const source = data.sourceUsed || '';
  setText('activeSet', source ? `Quelle: ${source}` : '');
  document.getElementById('footer').textContent = source ? `Quelle: ${source}` : '';
}

async function loadNow({ set, src } = {}) {
  showLoading();
  const qs = new URLSearchParams();
  if (set) qs.set('set', set);
  if (src) qs.set('src', src);

  try {
    const r = await fetch(`${API}/api/now?${qs.toString()}`);
    const data = await r.json();
    if (data.items?.length) {
      renderItems(data);
    } else {
      showError("Keine Programme", "Es wurden keine Programme gefunden.");
    }
    showAttempts(data.attempts || []);
  } catch (e) {
    showError("Ladefehler", e.message || String(e));
  }
}

// Auto-Refresh alle 5 Minuten
setInterval(()=> loadNow(), 300000);

// Initial: Live-Set
loadNow({ set: "live" });
</script>
</body>
</html>
