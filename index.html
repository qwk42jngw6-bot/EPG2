<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>EPG-2</title>
<style>
  body{background:#0f1419;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px}
  .container{max-width:1400px;margin:0 auto}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .ts{color:#9ca3af;font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
  .card{background:#1a1f26;border:1px solid #2a2f35;border-radius:8px;padding:12px}
  .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .ch{font-weight:600;font-size:14px}
  .no{color:#60a5fa;font-size:12px}
  .title{font-size:13px;margin-bottom:2px}
  .time{color:#9ca3af;font-size:11px}
  .noshow{color:#6b7280;font-size:12px;font-style:italic}
  .next{border-top:1px solid #2a2f35;margin-top:6px;padding-top:6px;color:#9ca3af;font-size:11px}
  .err{background:#7f1d1d;color:#fecaca;border:1px solid #ef4444;border-radius:8px;padding:10px;margin:8px 0}
  .badge{background:#374151;color:#cbd5e1;font-size:10px;border-radius:6px;padding:2px 6px;margin-left:8px}
  .src{color:#a7f3d0;font-size:12px;margin-left:8px}
  a.small{color:#93c5fd;text-decoration:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <strong>EPG-2</strong>
      <span id="src" class="src"></span>
    </div>
    <div class="ts" id="ts">lädt…</div>
  </div>

  <div id="err"></div>
  <div id="content"><div class="err">Lade Programm…</div></div>

  <div style="margin-top:10px;font-size:12px;color:#9ca3af">
    Debug: <a class="small" id="dbgLink" target="_blank" rel="noopener">/debug</a>
  </div>
</div>

<script>
const API = 'https://waterfall-epg.w2gy9ymm7y.workers.dev';
const params = new URLSearchParams(location.search);
const useParam = params.get('use'); // optional Liste durchreichen
document.getElementById('dbgLink').href = API + '/debug' + (useParam ? ('?use=' + encodeURIComponent(useParam)) : '');

async function load(){
  try{
    const url = API + '/api/now' + (useParam ? ('?use=' + encodeURIComponent(useParam)) : '');
    const r = await fetch(url);
    const j = await r.json();
    render(j);
  }catch(e){
    showErr('Verbindungsfehler: ' + e.message);
  }
}
function fmt(t){ return new Date(t).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}); }
function showErr(msg){ document.getElementById('err').innerHTML = '<div class="err">'+msg+'</div>'; }
function clearErr(){ document.getElementById('err').innerHTML = ''; }

function render(j){
  document.getElementById('ts').textContent = 'Stand: ' + (j.ts ? fmt(j.ts) : '–');
  const srcSpan = document.getElementById('src');
  srcSpan.textContent = j.debug && j.debug.sourceUsed ? 'Quelle: ' + j.debug.sourceUsed : '';

  if (j.error){
    let attempts = '';
    if (Array.isArray(j.attempts) && j.attempts.length){
      attempts = '<ul style="margin:6px 0 0 16px">';
      j.attempts.forEach(a=>{
        attempts += '<li><code>'+ (a.url||'') +'</code> — '+ (a.reason||'') +'</li>';
      });
      attempts += '</ul>';
    }
    showErr('API: ' + j.error + attempts);
  } else {
    clearErr();
  }

  const items = Array.isArray(j.items) ? j.items : [];
  let html = '';
  items.forEach(ch=>{
    html += '<div class="card">';
    html +=   '<div class="row"><div class="ch">'+ch.channel+'</div><div class="no">#'+ch.no+'</div></div>';
    if (ch.now){
      html += '<div class="title">'+ch.now.title+'</div>';
      html += '<div class="time">'+fmt(ch.now.start)+' – '+fmt(ch.now.stop)+'</div>';
    } else {
      html += '<div class="noshow">Keine aktuelle Sendung</div>';
    }
    if (Array.isArray(ch.next) && ch.next.length){
      html += '<div class="next">Danach: '+ch.next[0].title+' ('+fmt(ch.next[0].start)+')</div>';
    }
    html += '</div>';
  });
  document.getElementById('content').innerHTML = '<div class="grid">'+html+'</div>';
}

load();
setInterval(load, 300000);
</script>
</body>
</html>
