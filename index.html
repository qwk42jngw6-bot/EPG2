<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EPG – Jetzt (Germany 2)</title>
<style>
:root{
  --bg:#0b0d10; --card:#12151a; --border:#1f232b;
  --text:#e7ecf2; --muted:#9aa6b2;
  --accent:#5eead4;   /* Zeiten */
  --good:#86efac;     /* aktueller Titel */
  --chip:#1a222d;     /* Chips/Badges */
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif;font-size:14px; -webkit-font-smoothing:antialiased}
@media (max-width:420px){html,body{font-size:13px}}

header{padding:12px 14px;border-bottom:1px solid var(--border);
  position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(11,13,16,.92));z-index:10}
h1{margin:0 0 2px 0;font-size:18px;font-weight:800;letter-spacing:.2px}
.stamp{font-size:12px;color:var(--muted)}

.container{padding:12px;max-width:1100px;margin:0 auto}
.grid{display:grid;gap:10px}
@media(min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1080px){.grid{grid-template-columns:repeat(3,1fr)}}

.card{background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:12px;box-shadow:0 1px 0 rgba(255,255,255,.02) inset}

.top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.logo{
  width:28px;height:28px;border-radius:6px;overflow:hidden;
  display:inline-flex;align-items:center;justify-content:center;
  background:#0e1620;border:1px solid var(--border);flex:0 0 28px
}
.logo img{width:100%;height:100%;object-fit:contain;display:block}
.logo .mono{width:100%;height:100%;display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:800;color:#cfe7ff;letter-spacing:.3px}

.header-line{display:flex;align-items:baseline;justify-content:space-between;width:100%}
.ch{font-size:16px;font-weight:900;letter-spacing:.2px}
.no{font-size:11px;color:var(--muted);background:var(--chip);padding:2px 8px;border-radius:999px;border:1px solid var(--border)}

.now{font-weight:700;color:var(--good)}
.time{color:var(--accent)}
.muted{color:var(--muted)}
.warn{color:#facc15}
ul{padding-left:16px;margin:6px 0}
.rating{margin-top:6px;font-size:12px;color:#cbd5e1}
.badge{display:inline-block;background:var(--chip);border:1px solid var(--border);
  padding:2px 6px;border-radius:8px;margin-right:6px}
</style>
</head>
<body>
<header>
  <h1>EPG – Jetzt</h1>
  <div id="stamp" class="stamp"></div>
</header>

<div class="container">
  <div id="root" class="grid"></div>
</div>

<script>
const api="/api/now";
const $=s=>document.querySelector(s);
const stamp=$("#stamp"),root=$("#root");
const tt=d=>new Date(d).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});

// 1) Logo-Quellen: zuerst /logos/<slug>.png aus deinem Repo,
//    sonst (optional) direkte URL aus dieser Map (kannst du später füllen/ändern).
const CHANNEL_LOGOS = {
  "ARD (Das Erste)": "",   // wenn leer -> /logos/ard-das-erste.png versucht, sonst Monogramm
  "ZDF": "",
  "RTL": "",
  "ProSieben": "",
  "Sat.1": "",
  "SWR": "",
  "Sky Sport F1 (Formel 1)": "",
  "Motorvision TV": "",
  "Sky Cinema Highlights": "",
  "Sky Cinema Action": "",
  "Sky Cinema Primera": "",
  "Sky Cinema Classic": "",
  "Sky Cinema Family": "",
  "Warner Bros. (Film & Serie)": "",
  "VOX": "",
  "RTL Zwei": "",
  "Kabel Eins": "",
  "Kabel Eins Doku": "",
  "BBC Food": "",
  "DMAX": "",
  "BBC Top Gear": "",
  "N24 Doku": "",
  "Discovery Channel": "",
  "Sky Documentaries": "",
  "History Channel": "",
  "Sky Nature": "",
  "Terra Mater": "",
  "National Geographic": "",
  "National Geo Wild": "",
  "Animal Planet": "",
  "Welt": "",
  "N-TV": "",
  "Tagesschau24": "",
  "Nick (Nickelodeon)": "",
  "MTV": ""
};

// Slug für Dateinamen /logos/<slug>.png
const slug = s => s.toLowerCase()
  .replace(/ä/g,"ae").replace(/ö/g,"oe").replace(/ü/g,"ue").replace(/ß/g,"ss")
  .replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");

// Liefert Logo-URL oder "" (dann Monogramm nutzen)
function getLogoUrl(channel){
  const direct = CHANNEL_LOGOS[channel] || "";
  if (direct) return direct;
  // versuche statische Datei im Repo
  return "/logos/" + slug(channel) + ".png";
}

function logoEl(channel){
  const url = getLogoUrl(channel);
  const el = document.createElement("div");
  el.className = "logo";
  const img = new Image();
  img.src = url;
  img.alt = channel + " Logo";
  // Fallback: Monogramm (2 Buchstaben)
  const mono = document.createElement("div");
  mono.className = "mono";
  mono.textContent = channel.replace(/[^A-ZÄÖÜa-zäöü0-9]/g," ").trim().split(/\s+/).slice(0,2).map(w=>w[0]).join("").toUpperCase();
  // Wenn Bild lädt → anzeigen, sonst Monogramm
  img.onload = ()=>{ el.innerHTML=""; el.appendChild(img); };
  img.onerror = ()=>{ el.innerHTML=""; el.appendChild(mono); };
  // zunächst Monogramm, bis Bild (falls vorhanden) geladen ist
  el.appendChild(mono);
  return el;
}

function upcomingList(arr){
  if(!arr||!arr.length) return '<div class="muted">Keine weiteren Sendungen (2 h).</div>';
  return `<div><span class="badge">Nächste 2 Stunden</span>
    <ul>${arr.map(p=>`<li>${p.title} <span class="time">(${tt(p.start)}–${tt(p.stop)})</span></li>`).join("")}</ul></div>`;
}
function ratingBlock(r){
  if(!r) return "";
  const chips=[];
  if(r.gpt!=null) chips.push(`<span class="badge">GPT ${r.gpt}/10</span>`);
  if(r.imdb!=null) chips.push(`<span class="badge">IMDb ${r.imdb}</span>`);
  if(r.rtUser!=null) chips.push(`<span class="badge">RT-User ${r.rtUser}%</span>`);
  if(r.rtCritic!=null) chips.push(`<span class="badge">RT-Kritik ${r.rtCritic}%</span>`);
  return chips.length ? `<div class="rating">${chips.join("")}</div>` : "";
}

async function load(){
  stamp.textContent="Lade…";
  try{
    const r=await fetch(api,{cache:"no-store"});
    const j=await r.json();
    stamp.textContent="Stand: "+new Date(j.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    root.innerHTML="";
    for(const it of j.items){
      const card=document.createElement("div"); card.className="card";

      // Kopfzeile mit Logo + Name + #nr
      const top=document.createElement("div"); top.className="top";
      top.appendChild(logoEl(it.channel));
      const right=document.createElement("div"); right.className="header-line";
      right.innerHTML=`<div class="ch">${it.channel}</div><span class="no">#${it.no}</span>`;
      top.appendChild(right);
      card.appendChild(top);

      if(!it.now){
        card.insertAdjacentHTML("beforeend", `<div class="warn">Kein aktuelles Programm gefunden</div>`);
      }else{
        const when = it.now.start && it.now.stop ? ` <span class="time">(${tt(it.now.start)}–${tt(it.now.stop)})</span>` : "";
        card.insertAdjacentHTML("beforeend", `<div class="now">${it.now.title}${when}</div>`);
        card.insertAdjacentHTML("beforeend", upcomingList(it.upcoming));
        card.insertAdjacentHTML("beforeend", ratingBlock(it.rating));
      }
      root.appendChild(card);
    }
  }catch(e){
    stamp.textContent="Fehler: "+(e?.message||e);
  }
}
load();
</script>
</body>
</html>
