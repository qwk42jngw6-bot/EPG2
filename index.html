<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EPG – Jetzt</title>
<style>
  :root{
    --bg:#0f1419;--card:#161c22;--muted:#9aa4ae;--fg:#e6e9ed;--ok:#3ddc97;--border:#27303a;
    --ch:#d6dee6;--acc:#3b82f6;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  .stamp{font-size:.85rem;color:var(--muted);margin:4px 0 12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px}
  .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .ch{font-weight:700;color:var(--ch)}
  .no{font-size:.8rem;background:#17223a;color:#9ec5ff;border:1px solid #1b2c4f;padding:2px 8px;border-radius:999px}
  .now{color:var(--ok);font-weight:600;margin:2px 0}
  .t{color:var(--muted);font-size:.9rem}
  .next{margin-top:8px;border-top:1px dashed var(--border);padding-top:6px}
  .item{display:flex;justify-content:space-between;gap:8px;font-size:.95rem;color:#c9d2db;margin:2px 0}
  .err{background:#3a1114;border:1px solid #5b1a1f;color:#ffc4c7;padding:12px;border-radius:10px}
  @media (max-width:420px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <div id="stamp" class="stamp">Lade …</div>
    <div id="root" class="grid" aria-live="polite">
      <div class="card"><div class="t">Wird geladen …</div></div>
    </div>
  </div>

<script>
const API_BASE = "https://waterfall-epg.w2gy9ymm7y.workers.dev";

/* feste Senderliste (35) – Reihenfolge/Nummern fix */
const CHANNELS = [
  {no:1,  name:"ARD (Das Erste)"},{no:2,  name:"ZDF"},{no:3,  name:"RTL"},
  {no:4,  name:"ProSieben"},{no:5,  name:"Sat.1"},{no:6,  name:"SWR"},
  {no:7,  name:"Sky Sport F1 (Formel 1)"},{no:8,  name:"Motorvision TV"},
  {no:9,  name:"Sky Cinema Highlights"},{no:10, name:"Sky Cinema Action"},
  {no:11, name:"Sky Cinema Primera"},{no:12, name:"Sky Cinema Classic"},
  {no:13, name:"Sky Cinema Family"},{no:14, name:"Warner Bros. (Film & Serie)"},
  {no:15, name:"VOX"},{no:16, name:"RTL Zwei"},{no:17, name:"Kabel Eins"},
  {no:18, name:"Kabel Eins Doku"},{no:19, name:"BBC Food"},{no:20, name:"DMAX"},
  {no:21, name:"BBC Top Gear"},{no:22, name:"N24 Doku"},{no:23, name:"Discovery Channel"},
  {no:24, name:"Sky Documentaries"},{no:25, name:"History Channel"},
  {no:26, name:"Sky Nature"},{no:27, name:"Terra Mater"},
  {no:28, name:"National Geographic"},{no:29, name:"National Geo Wild"},
  {no:30, name:"Animal Planet"},{no:31, name:"Welt"},{no:32, name:"N-TV"},
  {no:33, name:"Tagesschau24"},{no:34, name:"Nick (Nickelodeon)"},{no:35, name:"MTV"}
];

function fmt(t){ const d=new Date(t); return isFinite(d)?d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}):"–"; }

async function loadEPG(){
  const root=document.getElementById('root');
  try{
    const r = await fetch(`${API_BASE}/api/now`, {cache:'no-store'});
    const j = await r.json();

    // Map aus API-Ergebnis: no -> daten
    const map = new Map((j.items||[]).map(x=>[x.no, x]));

    // Immer alle 35 rendern – wenn Daten fehlen: „Keine Sendung“
    const parts = CHANNELS.map(ch=>{
      const d = map.get(ch.no) || {no:ch.no, channel:ch.name, now:null, next:[]};
      const nowLine = d.now
        ? `<div class="now">${d.now.title}</div><div class="t">${fmt(d.now.start)} – ${fmt(d.now.stop)}</div>`
        : `<div class="t">Keine aktuelle Sendung</div>`;
      const nextLines = (d.next||[]).slice(0,2).map(n=>`
        <div class="item"><span>${n.title}</span><span class="t">${fmt(n.start)}</span></div>`).join('');
      return `
        <div class="card">
          <div class="head"><div class="ch">${d.channel}</div><div class="no">#${d.no}</div></div>
          ${nowLine}
          ${nextLines?`<div class="next">${nextLines}</div>`:""}
        </div>`;
    });

    root.innerHTML = parts.join('');
    document.getElementById('stamp').textContent =
      `Stand: ${new Date(j.ts||Date.now()).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}`;
  }catch(err){
    root.innerHTML = `<div class="err">Fehler beim Laden: ${err.message||err}</div>`;
    document.getElementById('stamp').textContent = 'Stand: Fehler';
  }
}

// Initial & Auto-Refresh (alle 5 Min / beim Tab-Focus)
loadEPG();
setInterval(loadEPG, 5*60*1000);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) loadEPG(); });
</script>
</body>
</html>
