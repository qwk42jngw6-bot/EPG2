<!-- index.html — EPG-UI mit Quellumschalter, Debug, Scan & Autorefresh -->

<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TV Programm – EPG</title>
<style>
  :root {
    --bg:#0f1419; --card:#1a1f26; --border:#2a2f35; --muted:#94a3b8;
    --text:#e5e7eb; --primary:#3b82f6; --danger:#ef4444; --ok:#10b981;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; line-height:1.4}
  .container{max-width:1200px; margin:0 auto; padding:16px;}
  .header{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); padding-bottom:12px; margin-bottom:12px}
  .hgroup{display:flex; flex-direction:column; gap:4px}
  h1{margin:0; font-size:20px}
  .muted{color:var(--muted); font-size:13px}

  .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  select,button,input[type=checkbox]{background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px; font-size:14px}
  button{cursor:pointer}
  button.primary{background:var(--primary); border-color:transparent}
  button.ghost{background:transparent}
  .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted)}
  .badge{font-size:10px; padding:2px 6px; border-radius:6px; background:#2b3440; color:#9ca3af}
  .badge.ok{background:#103a2f; color:#a7f3d0}
  .badge.err{background:#3a1010; color:#fecaca}

  .grid{display:grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap:10px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; position:relative}
  .row{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .title{font-weight:600}
  .sub{color:var(--muted); font-size:12px}
  .live{position:absolute; top:10px; right:10px; background:var(--danger); color:white; font-size:10px; font-weight:700; padding:3px 7px; border-radius:999px}
  .section{margin-top:16px}
  .table{width:100%; border-collapse:collapse; font-size:13px}
  .table th,.table td{border-bottom:1px solid var(--border); padding:8px; text-align:left; color:var(--text)}
  .table th{color:#cbd5e1}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px}
  .error{background:#3a1010; color:#fecaca; border:1px solid #7f1d1d; padding:12px; border-radius:8px; margin:10px 0}
  .success{background:#102f1f; color:#a7f3d0; border:1px solid #14532d; padding:12px; border-radius:8px; margin:10px 0}
  .small{font-size:12px}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="hgroup">
        <h1>TV Programm</h1>
        <div id="timestamp" class="muted">Bereit</div>
      </div>
      <div class="controls">
        <span class="tag">Set:
          <select id="set">
            <option value="single">single (kleine Feeds)</option>
            <option value="alt">alt (Alternativ)</option>
          </select>
        </span>
        <span class="tag">Quelle:
          <select id="source"></select>
        </span>
        <label class="tag">
          <input type="checkbox" id="useFallback" checked/> Fallback wenn leer
        </label>
        <button id="btnLoad" class="primary">Jetzt laden</button>
        <button id="btnLoadOne">Nur diese Quelle</button>
        <button id="btnScan" class="ghost">Alle prüfen</button>
        <label class="tag">
          <input type="checkbox" id="auto" /> Auto-Refresh 5 min
        </label>
      </div>
    </div>

    <div id="alerts"></div>

    <div id="stats" class="section"></div>
    <div id="grid" class="grid"></div>

    <div class="section">
      <h3>Letzte Versuche</h3>
      <table class="table mono" id="attemptsTbl">
        <thead><tr><th>#</th><th>URL</th><th>Status</th><th>CT</th><th>CE</th><th>Bytes</th><th>ms</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h3>Scan (Alle prüfen)</h3>
      <table class="table mono" id="scanTbl">
        <thead><tr><th>#</th><th>URL</th><th>Status</th><th>CT</th><th>Bytes</th><th>ms</th><th>Snippet</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const API_BASE = 'https://DEINNAME.workers.dev'; // HIER deine Worker-URL eintragen!

const el = (id) => document.getElementById(id);
const fmtTime = (iso) => new Date(iso).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});

async function api(path) {
  const r = await fetch(API_BASE + path);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function populateSources() {
  const set = el('set').value;
  const data = await api(`/api/sources?set=${encodeURIComponent(set)}`);
  const s = el('source');
  s.innerHTML = '';
  (data.sources || []).forEach(u => {
    const opt = document.createElement('option');
    opt.value = u; opt.textContent = u;
    s.appendChild(opt);
  });
  if (!s.value && s.options.length) s.selectedIndex = 0;
}

function showAlert(html, ok=false) {
  el('alerts').innerHTML = `<div class="${ok?'success':'error'}">${html}</div>`;
  setTimeout(()=>{ el('alerts').innerHTML=''; }, 5000);
}

function updateAttempts(tblId, list=[]) {
  const tb = el(tblId).querySelector('tbody');
  tb.innerHTML = '';
  list.forEach((a,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="mono small" style="word-break:break-all">${a.src || a.url}</td>
      <td>${badge(a.ok? 'ok':'err', (a.status||0))}</td>
      <td class="small">${a.ct||''}</td>
      <td class="small">${a.ce||''}</td>
      <td>${a.len||''}</td>
      <td>${a.ms||''}</td>
    `;
    tb.appendChild(tr);
  });
}

function badge(type, txt){ return `<span class="badge ${type==='ok'?'ok':'err'}">${txt}</span>`; }

function renderGrid(items=[]) {
  const g = el('grid');
  g.innerHTML = '';
  items.forEach(ch=>{
    const has = ch.now && ch.now.title;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      ${has?'<div class="live">LIVE</div>':''}
      <div class="row">
        <div class="title">${ch.channel}</div>
        <div class="badge">${'#'+ch.no}</div>
      </div>
      <div class="section">
        ${has? `
          <div><strong>${ch.now.title}</strong></div>
          <div class="sub">${fmtTime(ch.now.start)} – ${fmtTime(ch.now.stop)}</div>
        `: `<div class="sub">Keine aktuelle Sendung</div>`}
      </div>
      ${Array.isArray(ch.next) && ch.next.length? `
        <div class="section">
          ${ch.next.map(n=>`<div class="sub">Danach: <span class="title">${n.title}</span> · ${fmtTime(n.start)}</div>`).join('')}
        </div>`:``}
    `;
    g.appendChild(card);
  });
}

function renderStats(items=[], srcUsed) {
  const total = items.length;
  const live = items.filter(x=>x.now).length;
  el('stats').innerHTML = `
    <div class="row">
      <div>Quelle: <span class="badge">${srcUsed || '—'}</span></div>
      <div class="row" style="gap:8px">
        <span class="badge">Kanäle: ${total}</span>
        <span class="badge ok">Live: ${live}</span>
      </div>
    </div>
  `;
}

async function loadNow({ onlyThis=false } = {}) {
  const set = el('set').value;
  const src = el('source').value;
  const fallback = el('useFallback').checked ? '1':'0';
  let path = `/api/now?set=${encodeURIComponent(set)}&fallback=${fallback}`;
  if (onlyThis && src) path += `&source=${encodeURIComponent(src)}`;

  el('timestamp').textContent = 'Lade...';
  try {
    const data = await api(path);
    if (data.error) showAlert(`EPG-Fehler: ${data.error}`);
    renderGrid(data.items || []);
    renderStats(data.items || [], data.sourceUsed);
    updateAttempts('attemptsTbl', data.attempts || []);
    el('timestamp').textContent = `Aktualisiert: ${new Date().toLocaleString('de-DE')}`;
  } catch(e) {
    showAlert('Netzwerkfehler beim Laden.');
    el('timestamp').textContent = 'Fehler';
  }
}

async function doScan() {
  const set = el('set').value;
  el('timestamp').textContent = 'Scan läuft...';
  try {
    const data = await api(`/api/debug-scan?set=${encodeURIComponent(set)}`);
    updateAttempts('scanTbl', data.results || []);
    el('timestamp').textContent = `Scan fertig: ${new Date().toLocaleString('de-DE')}`;
  } catch(e) {
    showAlert('Scan fehlgeschlagen.');
    el('timestamp').textContent = 'Fehler';
  }
}

let autoTimer = null;
function toggleAuto() {
  const on = el('auto').checked;
  if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
  if (on) {
    autoTimer = setInterval(()=>loadNow({onlyThis:false}), 5*60*1000);
  }
}

// Init
(async function init(){
  await populateSources();
  await loadNow({ onlyThis:false });

  el('set').addEventListener('change', async ()=>{
    await populateSources();
  });
  el('btnLoad').addEventListener('click', ()=>loadNow({onlyThis:false}));
  el('btnLoadOne').addEventListener('click', ()=>loadNow({onlyThis:true}));
  el('btnScan').addEventListener('click', doScan);
  el('auto').addEventListener('change', toggleAuto);
})();
</script>
</body>
</html>
