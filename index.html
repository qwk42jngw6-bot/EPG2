<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EPG – Jetzt (Germany 2)</title>

<!-- Externes Design-Paket (ohne Build): Pico.css -->
<link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2/css/pico.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* ==== Feinschliff auf Basis Pico (Apple-clean) ==== */
:root{
  --bg:#0c1015; --card:#111824; --card2:#0f1621; --border:#1d2735;
  --text:#e8edf3; --muted:#9aa6b2;
  --accent:#67e8f9; --live:#86efac;
  --chip:#121a26;
  --gpt:#60a5fa; --imdb:#facc15; --rtU:#ef4444; --rtC:#22c55e;
}
:root, [data-theme="dark"]{
  --pico-background-color: var(--bg);
  --pico-color: var(--text);
  --pico-muted-color: var(--muted);
  --pico-card-background-color: var(--card);
  --pico-border-color: var(--border);
  --pico-form-element-background-color: var(--card2);
}
html,body{font-family:Inter, ui-sans-serif, -apple-system, "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
.container{max-width:1120px;margin-inline:auto;padding:1rem 1rem 2.25rem;}
header.header{
  position:sticky; top:0; z-index:10;
  backdrop-filter:saturate(180%) blur(8px);
  background:linear-gradient(180deg, rgba(12,16,21,.9), rgba(12,16,21,.75));
  border-bottom:1px solid var(--border);
}
h1{margin:0 0 .25rem 0; font-weight:800; letter-spacing:.2px}
#stamp{font-size:.85rem; color:var(--muted)}

.grid{display:grid; gap:14px}
@media (min-width:760px){ .grid{grid-template-columns:repeat(2, minmax(0,1fr));} }
@media (min-width:1100px){ .grid{grid-template-columns:repeat(3, minmax(0,1fr));} }

.card{
  border:1px solid var(--border); border-radius:14px;
  background:linear-gradient(180deg,var(--card),var(--card2));
  padding:14px 14px 12px; box-shadow: 0 12px 30px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.03);
  transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
}
.card:hover{ transform: translateY(-2px); border-color:#2b3a50; box-shadow: 0 16px 34px rgba(0,0,0,.26), inset 0 1px 0 rgba(255,255,255,.05); }

.top{display:flex; align-items:baseline; justify-content:space-between; margin-bottom:.5rem}
.ch{font-weight:800; font-size:1.05rem}
.no{font-size:.72rem; color:var(--muted); background:var(--chip); border:1px solid var(--border);
    padding:.18rem .55rem; border-radius:9999px}

.now{font-weight:800; color:var(--live)}
.time{color:var(--accent)}
.muted{color:var(--muted)}
.warn{color:#facc15}

ul{margin:.6rem 0 .2rem .2rem}
ul li{margin:.15rem 0}

.badges{display:flex; flex-wrap:wrap; gap:.4rem; margin-top:.55rem}
.badge{
  font-size:.78rem; padding:.28rem .55rem; border-radius:.6rem; border:1px solid var(--border);
  background:var(--chip); line-height:1;
}
.badge.gpt{ color:var(--gpt); border-color: color-mix(in oklab, var(--gpt) 60%, #000) }
.badge.imdb{ color:var(--imdb); border-color: color-mix(in oklab, var(--imdb) 60%, #000) }
.badge.rtU{ color:var(--rtU); border-color: color-mix(in oklab, var(--rtU) 60%, #000) }
.badge.rtC{ color:var(--rtC); border-color: color-mix(in oklab, var(--rtC) 60%, #000) }

.small{font-size:.8rem; color:var(--muted); margin-top:.4rem}
hr.sep{border-color:var(--border); opacity:.5; margin:.6rem 0}

/* Auto-Refresh Indicator */
.refresh-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  background: var(--live);
  border-radius: 50%;
  margin-right: 8px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
</style>
</head>
<body>

<header class="header">
  <div class="container">
    <h1>EPG – Jetzt</h1>
    <div id="stamp"><span class="refresh-indicator"></span>Lade aktuelle Sendungen...</div>
  </div>
</header>

<main class="container">
  <div id="root" class="grid"></div>
</main>

<script>
const API_BASE = "https://waterfall-epg.w2gy9ymm7y.workers.dev";
const api = API_BASE + "/api/now";
const REFRESH_INTERVAL = 300000; // 5 Minuten

const fmtTime = d => new Date(d).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

function nextList(arr){
  if(!arr || !arr.length) return '<p class="muted" style="margin:.35rem 0 0">Keine weiteren Sendungen.</p>';
  return `<ul>${arr.slice(0,2).map(p=>(
    `<li>${p.title} <span class="time">(${fmtTime(p.start)}–${fmtTime(p.stop)})</span></li>`
  )).join("")}</ul>`;
}

function ratings(r){
  if(!r) return "";
  const chips=[];
  if(r.imdb!=null) chips.push(`<span class="badge imdb">IMDb ${r.imdb}</span>`);
  if(r.rtUser!=null) chips.push(`<span class="badge rtU">RT-User ${r.rtUser}%</span>`);
  if(r.rtCritic!=null) chips.push(`<span class="badge rtC">RT-Kritik ${r.rtCritic}%</span>`);
  return chips.length ? `<div class="badges">${chips.join("")}</div>` : "";
}

async function load(){
  const stamp = document.getElementById("stamp");
  const root = document.getElementById("root");
  
  try{
    const r = await fetch(api, {cache:"no-store"});
    const j = await r.json();

    stamp.innerHTML = `<span class="refresh-indicator"></span>Stand: ${new Date(j.ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"})}`;
    root.innerHTML = "";

    if (!j.items || j.items.length === 0) {
      root.innerHTML = '<article class="card"><p class="muted">Keine Sendungen gefunden</p></article>';
      return;
    }

    for (const it of j.items){
      const card = document.createElement("article");
      card.className = "card";

      const head = `
        <div class="top">
          <div class="ch">${it.channel}</div>
          <span class="no">#${it.no}</span>
        </div>`;

      if (!it.now){
        card.innerHTML = head + `<p class="warn">Kein aktuelles Programm gefunden</p>`;
      } else {
        const when = (it.now.start && it.now.stop) ? ` <span class="time">(${fmtTime(it.now.start)}–${fmtTime(it.now.stop)})</span>` : "";
        card.innerHTML = head
          + `<p class="now" style="margin:.15rem 0 .35rem">${it.now.title}${when}</p>`
          + nextList(it.next)
          + ratings(it.rating)
          + (it.now.description ? `<div class="small">${it.now.description}</div>` : "");
      }

      root.appendChild(card);
    }
  }catch(e){
    stamp.innerHTML = `<span class="warn">⚠️</span> Fehler: ${e?.message || e}`;
    console.error('Load error:', e);
  }
}

// Auto-Refresh
load();
setInterval(load, REFRESH_INTERVAL);
</script>
</body>
</html>
